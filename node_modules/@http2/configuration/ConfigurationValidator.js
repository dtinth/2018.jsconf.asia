const Validator = require('jsonschema/lib/validator')
const {manifestSchema} = require('./schema/manifest')
const {hostSchema} = require('./schema/host')
const {optionsSchema} = require('./schema/options')
const {isExtglob} = require('./formats/isExtglob')
const {isCalculation} = require('./formats/isCalculation')

module.exports.ConfigurationValidator =
class ConfigurationValidator extends Validator {
  constructor () {
    super()

    this.customFormats.extglob = isExtglob
    this.customFormats.calculation = isCalculation

    this.addSchema(manifestSchema, '/Manifest')
    this.addSchema(hostSchema, '/Host')
    this.addSchema(optionsSchema, '/Options')
  }

  validate (instance) {
    const schema = {'$ref': '/Options'}
    const {errors} = super.validate(instance, schema)
    if (errors.length) {
      delete errors[0].schema
      throw errors[0]
    }
    return true
  }
}
