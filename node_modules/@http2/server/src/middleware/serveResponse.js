const Negotiator = require('negotiator')
const {createReadStream, stat} = require('fs')
const {promisify} = require('util')
const {buildHeaders} = require('../helpers/buildHeaders')

function noop () {}

async function serveResponse (request, response, next) {
  const {resolved, headers} = buildHeaders(
    request.resolved,
    request.options.cacheControl.immutable,
    new Negotiator(request).encodings(),
    request.fileIndex
  )

  if (request.httpVersionMajor === 2) {
    // HTTP/2 GET
    request.once('error', noop)
    response.once('error', noop)
    response.stream.once('error', () => {
      if (response.stream.destroyed === false) {
        response.stream.respond({
          ':status': 500,
          'content-type': 'text/plain'
        })
        response.stream.end('Internal Server Error')
      }
    })
    response.stream.respondWithFile(resolved.absolute, headers, {
      statCheck (stat, headers) {
        headers['content-length'] = stat.size
        if (request.method === 'HEAD') {
          // HTTP/2 HEAD
          response.stream.respond(headers)
          return false
        }
      }
    })
    next()
  } else {
    if (request.method === 'HEAD') {
      // HTTP/1 HEAD
      response.writeHead(200, headers)
      response.flushHeaders()
      response.end()
      next()
    } else {
      // HTTP/1 GET
      const file = createReadStream(resolved.absolute)
      file.once('open', async () => {
        let size
        try {
          ({size} = await promisify(stat)(resolved.absolute))
        } catch (error) {
          return next(error)
        }
        response.setHeader('content-length', size)
        response.writeHead(200, headers)
        file.pipe(response)
        next()
      })
      file.once('error', (error) => {
        file.removeAllListeners()
        if (!response.headersSent) next(error)
        else if (!response.finished) response.end()
      })
      file.once('end', () => {
        file.removeAllListeners()
      })
    }
  }
}

module.exports.serveResponse = () => serveResponse
